FROM dappforce/subsocial-base-polkaverse as builder

ARG GH_GA_ID
ARG GH_CONNECTION_KIND
ARG GH_APP_KIND
ARG GH_APP_BASE_URL
ARG GH_HCAPTCHA_SITE_KEY
ARG GH_AMP_ID
ARG GH_OFFCHAIN_SIGNER_URL
ARG GH_SELLER_CLIENT_ID
ARG GH_SELLER_TOKEN_SIGNER
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_DATAHUB_QUEUE_TOKEN
ARG GH_SERVER_MNEMONIC

ENV NEXT_PUBLIC_GA_ID=${GH_GA_ID} \
    NEXT_PUBLIC_APP_KIND=${GH_APP_KIND} \
    NEXT_PUBLIC_APP_BASE_URL=${GH_APP_BASE_URL} \
    NEXT_PUBLIC_HCAPTCHA_SITE_KEY=${GH_HCAPTCHA_SITE_KEY} \
    NEXT_PUBLIC_AMP_ID=${GH_AMP_ID} \
    NEXT_PUBLIC_OFFCHAIN_SIGNER_URL=${GH_OFFCHAIN_SIGNER_URL} \
    NEXT_PUBLIC_CONNECTION_KIND=${GH_CONNECTION_KIND} \
    SELLER_CLIENT_ID=${GH_SELLER_CLIENT_ID} \
    SELLER_CLIENT_TOKEN_SIGNER=${GH_SELLER_TOKEN_SIGNER} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    DATAHUB_QUEUE_TOKEN=${GH_DATAHUB_QUEUE_TOKEN} \
    SERVER_MNEMONIC=${GH_SERVER_MNEMONIC}

COPY package.json yarn.lock* ./
RUN yarn install --no-optional

WORKDIR /opt/subsocial/app
COPY . .

RUN yarn

COPY ci.env .env
RUN NODE_ENV=production yarn build

FROM gcr.io/distroless/nodejs:16 AS runner

ARG GH_GA_ID
ARG GH_CONNECTION_KIND
ARG GH_APP_KIND
ARG GH_APP_BASE_URL
ARG GH_HCAPTCHA_SITE_KEY
ARG GH_AMP_ID
ARG GH_OFFCHAIN_SIGNER_URL
ARG GH_SELLER_CLIENT_ID
ARG GH_SELLER_TOKEN_SIGNER
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_DATAHUB_QUEUE_TOKEN
ARG GH_SERVER_MNEMONIC

ENV NEXT_PUBLIC_GA_ID=${GH_GA_ID}  \
    NEXT_PUBLIC_APP_KIND=${GH_APP_KIND} \
    NEXT_PUBLIC_APP_BASE_URL=${GH_APP_BASE_URL} \
    NEXT_PUBLIC_AMP_ID=${GH_AMP_ID} \
    NEXT_PUBLIC_OFFCHAIN_SIGNER_URL=${GH_OFFCHAIN_SIGNER_URL} \
    NEXT_PUBLIC_CONNECTION_KIND=${GH_CONNECTION_KIND} \
    SELLER_CLIENT_ID=${GH_SELLER_CLIENT_ID} \
    SELLER_CLIENT_TOKEN_SIGNER=${GH_SELLER_TOKEN_SIGNER} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    DATAHUB_QUEUE_TOKEN=${GH_DATAHUB_QUEUE_TOKEN} \
    SERVER_MNEMONIC=${GH_SERVER_MNEMONIC}

WORKDIR /opt/subsocial/app

COPY --from=builder /opt/subsocial/app .

CMD [ "server.js" ]
